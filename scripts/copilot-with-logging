#!/bin/bash

# Wrapper script for copilot CLI that logs token usage
# Usage: ./copilot-with-logging [copilot options]
# Or create an alias: alias copilot="path/to/copilot-with-logging"

# Configuration
API_URL="${TOKEN_LOGGER_API_URL:-http://localhost:3001}"
LOGS_DIR="./logs"
mkdir -p "$LOGS_DIR"
COPILOT_BIN="/opt/homebrew/bin/copilot"

# Generate session info
SESSION_ID="copilot_$(date +%s)"
TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

# Run the actual copilot command and capture both output and exit code
START_TIME=$(date +%s)
OUTPUT=$("$COPILOT_BIN" --allow-all-tools "$@" 2>&1)
EXIT_CODE=$?
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

# Display the output
echo "$OUTPUT"

# Parse token information from output if it contains usage stats
# Format: claude-sonnet-4.5  35.2k in, 310 out, 22.4k cached
if echo "$OUTPUT" | grep -q "Breakdown by AI model:"; then
    model=$(echo "$OUTPUT" | grep -o 'claude-[a-z0-9.-]*' | head -1)
    input_tokens=$(echo "$OUTPUT" | grep -oE '[0-9.]+k? (in|input)' | sed -E 's/ (in|input)//' | head -1)
    output_tokens=$(echo "$OUTPUT" | grep -oE '[0-9.]+k? (out|output)' | sed -E 's/ (out|output)//' | head -1)
    cache_read_tokens=$(echo "$OUTPUT" | grep -oE '[0-9.]+k? (cached|cache read)' | sed -E 's/ (cached|cache read)//' | head -1)
    cache_creation_tokens=$(echo "$OUTPUT" | grep -oE '[0-9.]+k? cache creation' | sed 's/ cache creation//' | head -1)

    # Convert k notation to actual numbers
    convert_k() {
        local val="$1"
        if [ -z "$val" ]; then
            echo "0"
            return
        fi
        if echo "$val" | grep -q 'k$'; then
            local num=$(echo "$val" | sed 's/k$//')
            echo "$num" | awk '{printf "%.0f", $1 * 1000}'
        else
            echo "$val"
        fi
    }

    input_tokens=$(convert_k "$input_tokens")
    output_tokens=$(convert_k "$output_tokens")
    cache_read_tokens=$(convert_k "$cache_read_tokens")
    cache_creation_tokens=$(convert_k "$cache_creation_tokens")

    # Ensure they're numbers
    [[ "$input_tokens" =~ ^[0-9]+$ ]] || input_tokens=0
    [[ "$output_tokens" =~ ^[0-9]+$ ]] || output_tokens=0
    [[ "$cache_read_tokens" =~ ^[0-9]+$ ]] || cache_read_tokens=0
    [[ "$cache_creation_tokens" =~ ^[0-9]+$ ]] || cache_creation_tokens=0

    TOTAL_TOKENS=$((input_tokens + output_tokens))

    # Log token usage if we found any
    if [ "$TOTAL_TOKENS" -gt 0 ]; then
        LOG_FILE="$LOGS_DIR/copilot-wrapper.log"

        # Get the command that was run (sanitize for logging)
        COMMAND_ARGS="$*"
        COMMAND_PREVIEW=$(echo "$COMMAND_ARGS" | head -c 100)

        echo "[${TIMESTAMP}] SESSION: $SESSION_ID | Model: $model | In: $input_tokens | Out: $output_tokens | Cache: $cache_read_tokens | Total: $TOTAL_TOKENS | Duration: ${DURATION}s | Command: $COMMAND_PREVIEW" >> "$LOG_FILE"

        # Send to API
        DURATION_MS=$((DURATION * 1000))
        curl -s --connect-timeout 2 -X POST "${API_URL}/api/copilot/tokens" \
            -H "Content-Type: application/json" \
            -d "{
                \"session_id\": \"${SESSION_ID}\",
                \"input_tokens\": ${input_tokens},
                \"output_tokens\": ${output_tokens},
                \"cache_read_tokens\": ${cache_read_tokens},
                \"cache_creation_tokens\": ${cache_creation_tokens},
                \"model\": \"${model}\",
                \"user\": \"${USER}\",
                \"timestamp\": \"${TIMESTAMP}\",
                \"duration_ms\": ${DURATION_MS}
            }" > /dev/null 2>&1 || true
    fi
fi

# Exit with the same code as copilot
exit $EXIT_CODE
